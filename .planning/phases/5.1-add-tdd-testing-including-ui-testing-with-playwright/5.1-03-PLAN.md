---
phase: 5.1-add-tdd-testing-including-ui-testing-with-playwright
plan: 03
type: execute
domain: testing
---

<objective>
Write end-to-end (E2E) UI tests with Playwright to validate the complete image generation workflow in a real browser.

Purpose: Verify the entire user journey works correctly from prompt input to image display, including loading states, error handling, retry button, and download functionality.
Output: Playwright E2E tests covering the image generation workflow, error scenarios, and UI interactions, with >70% user flow coverage.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phases with UI implementation:
@.planning/phases/03-generation-ui/03-01-SUMMARY.md
@.planning/phases/05-error-handling/05-01-SUMMARY.md
@.planning/phases/5.1-add-tdd-testing-including-ui-testing-with-playwright/5.1-01-SUMMARY.md

# UI components to test:
@src/App.tsx
@src/components/ui/PromptInput.tsx
@src/components/ui/GenerateButton.tsx

**Tech stack available:**
- Playwright with browser automation (from Plan 1)
- Vite dev server on port 5173
- React app with controlled components

**Established patterns:**
- Textarea for prompt input (100-500 characters)
- Status-based button text (idle â†’ pending â†’ processing â†’ succeeded/failed)
- Error display with userMessage and ðŸ’¡ suggestion
- Retry button for retryable errors
- Download button for generated images
- Start over button to clear state

**User workflow to test:**
1. Enter prompt in textarea
2. Click "Generate Image" button
3. Button shows "Creating task..." then "Generating..."
4. After 1-2 minutes, image displays or error shows
5. On success: Download and Start Over buttons appear
6. On retryable error: "Try Again" button appears
7. Console logs show [Image Generation] lifecycle

**Current issues to validate:**
- Complete E2E workflow from prompt to image
- Error handling displays correctly in UI
- Retry button works for retryable errors
- Download button saves image
- Start over button clears state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test for happy path (successful image generation)</name>
  <files>tests/e2e/happy-path.spec.ts</files>
  <action>
Create Playwright E2E test for successful image generation:
1. Navigate to http://localhost:5173
2. Locate textarea prompt input
3. Fill in test prompt: "a beautiful sunset over mountains"
4. Click "Generate Image" button
5. Verify button text changes: "Creating task..." â†’ "Generating..."
6. Wait for image to appear (timeout: 120000ms for 2-minute generation)
7. Verify image element is visible
8. Verify Download button is present
9. Verify Start Over button is present
10. Verify no error message displayed
11. Check console for [Image Generation] logs

WHY 120 second timeout:
- DashScope API takes 1-2 minutes for image generation
- Playwright default 30s timeout is too short
- 120s gives buffer for slow API responses

WHY console log checking:
- Validates AI-optimized logging from Phase 5
- Confirms [Image Generation] lifecycle logs appear
- Helps debugging when tests fail
  </action>
  <verify>
1. `npx playwright test tests/e2e/happy-path.spec.ts` passes
2. Test completes in ~2 minutes (actual generation time)
3. Screenshot on failure shows what went wrong
4. Console logs are captured in test report
  </verify>
  <done>
Happy path E2E test validates complete workflow from prompt to image display
</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E tests for error scenarios</name>
  <files>tests/e2e/error-scenarios.spec.ts</files>
  <action>
Create Playwright E2E tests for error handling:
Test 1: Empty prompt validation
- Click "Generate Image" with empty textarea
- Verify button is disabled or validation message shows

Test 2: API error display (mock API failure)
- Use MSW (Mock Service Worker) or route mocking to simulate API error
- Mock generateImage() to reject with 400 Bad Request
- Verify error message displays in UI
- Verify error message is user-friendly (not raw API error)
- Verify ðŸ’¡ suggestion shows
- Verify [UI Error Displayed] console log appears

Test 3: Retry button functionality
- Mock API to return rate limit error (isRetryable: true)
- Trigger generation
- Verify error displays with "Try Again" button
- Click "Try Again" button
- Verify retry is triggered (check console logs for [Retry])
- After 3 retries, verify final error shows

Test 4: Download button
- Mock successful image generation
- Load page with pre-generated image
- Click Download button
- Verify file download starts (check download event)

Test 5: Start over button
- Generate image (mock or real)
- Click "Start Over"
- Verify image disappears
- Verify prompt clears
- Verify status returns to 'idle'
  </action>
  <verify>
1. All 5 error scenario tests pass
2. MSW or route mocking works correctly
3. Error messages display user-friendly text
4. Retry button triggers actual retry (check console logs)
5. Download and Start Over buttons function correctly
  </verify>
  <done>
Error scenario E2E tests cover validation, API errors, retry functionality, and button interactions
</done>
</task>

<task type="auto">
  <name>Task 3: Create E2E test for responsive design</name>
  <files>tests/e2e/responsive-design.spec.ts</files>
  <action>
Create Playwright E2E test for responsive UI:
Test 1: Desktop view (1920x1080)
- Set viewport to 1920x1080
- Verify layout: prompt textarea centered, generate button below
- Verify image displays at reasonable size
- Verify no horizontal scrollbars

Test 2: Tablet view (768x1024)
- Set viewport to 768x1024
- Verify layout adapts (textarea narrower, still usable)
- Verify button text doesn't wrap awkwardly
- Verify image scales down appropriately

Test 3: Mobile view (375x667)
- Set viewport to 375x667 (iPhone SE)
- Verify single column layout
- Verify textarea is full width (with margins)
- Verify button is still clickable
- Verify error messages don't overflow
- Verify image fits within viewport width

WHY responsive testing:
- Phase 6 will implement responsive design
- Tests validate current state before Phase 6
- Tests ensure Phase 6 changes don't break mobile
- Catch layout issues early before deployment
  </action>
  <verify>
1. All 3 viewport tests pass
2. No horizontal scrollbars at any viewport size
3. UI elements are clickable and visible on all devices
4. Screenshot comparison shows layout differences (optional)
  </verify>
  <done>
Responsive design E2E tests validate UI works on desktop, tablet, and mobile viewports
</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All E2E tests pass: `npm run test:e2e`
- [ ] Happy path test completes successfully (may take 2+ minutes)
- [ ] Error scenario tests all pass
- [ ] Responsive design tests pass for all viewports
- [ ] API mocking works correctly (MSW or Playwright route mocking)
- [ ] Console logs are captured in test reports
- [ ] Screenshot on failure shows debugging info
- [ ] Test coverage includes all user workflows
</verification>

<success_criteria>

- Happy path E2E test validates complete image generation workflow
- Error scenario tests validate error handling and retry functionality
- Responsive design tests validate UI works on all device sizes
- E2E test coverage >70% for critical user flows
- All tests pass consistently (not flaky)
- Test reports provide useful debugging information
- Ready for Phase 6: Polish with confidence that core functionality works
  </success_criteria>

<output>
After completion, create `.planning/phases/5.1-add-tdd-testing-including-ui-testing-with-playwright/5.1-03-SUMMARY.md`:

# Phase 5.1 Plan 3: E2E UI Tests Summary

**End-to-end testing with Playwright covering happy path, error scenarios, and responsive design**

## Accomplishments

- Created happy path E2E test for successful image generation workflow
- Created error scenario E2E tests for validation, API errors, retry, and button functionality
- Created responsive design E2E tests for desktop, tablet, and mobile viewports
- Validated AI-optimized console logging appears in browser
- Achieved >70% E2E test coverage for user flows

## Files Created/Modified

- `tests/e2e/happy-path.spec.ts` - Complete workflow from prompt to image
- `tests/e2e/error-scenarios.spec.ts` - Error handling and retry functionality
- `tests/e2e/responsive-design.spec.ts` - Multi-device layout validation
- `playwright.config.ts` - Updated with MSW or route mocking configuration

## Commits

1. **feat(5.1-03): create happy path E2E test**
2. **feat(5.1-03): create error scenario E2E tests**
3. **feat(5.1-03): create responsive design E2E tests**
4. **chore(5.1-03): configure API mocking for E2E tests**

## Decisions Made

- **120 second timeout** - Accounts for DashScope's 1-2 minute generation time
- **Sequential E2E execution** - Prevents API rate limit issues (from Plan 1)
- **MSW for API mocking** - Mock Service Worker for reliable error testing without real API calls
- **Screenshot on failure** - Automatic screenshots help debug failing tests
- **Console log capture** - Validates AI-optimized logging from Phase 5

## Issues Encountered

None - E2E tests worked as expected with Playwright configuration.

## Next Phase Readiness

- Core business logic fully tested (Plan 2)
- User workflows validated in real browser (Plan 3)
- Error handling confirmed to work end-to-end
- Responsive design baseline established before Phase 6
- Ready for Phase 6: Polish with test safety net

## Complete Phase 5.1

Phase 5.1: Add TDD Testing Including UI Testing with Playwright - COMPLETE
- Test frameworks setup (Vitest + Playwright)
- Unit/integration tests written with TDD
- E2E UI tests covering all workflows
- Comprehensive test coverage achieved
</output>
