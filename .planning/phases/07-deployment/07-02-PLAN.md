---
phase: 07-deployment
type: execute
---

<objective>
Deploy the application to mekaelturner.com server using nginx for static file serving and API proxying.

Purpose: Make the application publicly accessible at image-generator.mekaelturner.com with working API calls through nginx reverse proxy.
Output: Deployed application accessible via https://image-generator.mekaelturner.com with image generation working end-to-end.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/07-deployment/07-01-SUMMARY.md
@.planning/phases/02-qwen-integration/02-01-SUMMARY.md
@.planning/phases/05-error-handling/05-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@vite.config.ts
@src/lib/qwen-api.ts
@.env.example

**Tech stack available:** React 19, Vite 6, TypeScript, Tailwind CSS v4
**Established patterns:**
- Production build configured (from 07-01)
- .env.example documents DASHSCOPE_API_KEY
- Vite dev server proxies /api/qwen to DashScope API

**Server Environment (mekaelturner.com):**
- OS: Ubuntu 24.04 LTS
- RAM: 961MB (limited - nginx-only deployment required)
- CPU: 1 core
- Disk: 20GB free
- Python 3: Installed
- Node.js: Not installed
- nginx: Not installed (will install)
- Firewall: Inactive

**Constraining decisions:**
- Phase 2: DashScope API integration (synchronous mode)
- Phase 2: Beijing region API endpoint
- Phase 7-01: Production build configured
- **Custom domain**: image-generator.mekaelturner.com
- **Deployment target**: User's existing DigitalOcean server (mekaelturner)
- **nginx-only**: No Node.js backend due to limited RAM

**Issues being addressed:**
- Build static files locally
- Install nginx on server
- Configure nginx reverse proxy for API calls
- Add DashScope API key to nginx config
- Set up SSL certificate with certbot
- Configure DNS for custom subdomain

**From STATE.md:**
- Ready for deployment
- E2E tests passing (19/19)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build production bundle locally</name>
  <files>dist/ (build output)</files>
  <action>
Build the React application for production on the local machine (Raspberry Pi):

1. Navigate to project directory:
   ```bash
   cd /home/mekael/Documents/ai-image-generator
   ```

2. Create production build:
   ```bash
   npm run build
   ```

3. Verify build output:
   ```bash
   ls -la dist/
   ```
   Should show: index.html, assets/ directory with JS/CSS files

4. Test production build locally:
   ```bash
   npm run preview
   ```
   Visit http://localhost:4173 and verify app loads

5. Create .env.production for reference (DO NOT commit):
   ```bash
   echo "VITE_DASHSCOPE_API_KEY=your_api_key_here" > .env.production
   ```

WHY: Building locally is faster than building on the server. The dist/ folder contains static HTML/CSS/JS files that nginx can serve directly.
  </action>
  <verify>
- dist/ directory exists
- dist/index.html exists
- dist/assets/ contains JS and CSS files
- npm run preview works locally
- Build completed without errors
  </verify>
  <done>
Production build created in dist/ directory, ready for upload to server
  </done>
</task>

<task type="auto">
  <name>Task 2: Install and configure nginx on server</name>
  <files>server: /etc/nginx/sites-available/image-generator</files>
  <action>
Install nginx on mekaelturner server and configure it to serve the app:

1. Install nginx and certbot (for SSL):
   ```bash
   ssh mekaelturner "apt update && apt install -y nginx certbot python3-certbot-nginx"
   ```

2. Create web root directory:
   ```bash
   ssh mekaelturner "mkdir -p /var/www/image-generator"
   ```

3. Upload dist/ contents to server:
   ```bash
   rsync -avz --delete dist/ mekaelturner:/var/www/image-generator/
   ```

4. Create nginx site configuration:
   ```bash
   ssh mekaelturner "cat > /etc/nginx/sites-available/image-generator << 'EOF'
server {
    listen 80;
    server_name image-generator.mekaelturner.com;

    # Serve React static files
    root /var/www/image-generator;
    index index.html;

    # Handle React Router
    location / {
        try_files \$uri \$uri/ /index.html;
    }

    # Cache static assets
    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control \"public, immutable\";
    }

    # Security headers
    add_header X-Frame-Options \"SAMEORIGIN\" always;
    add_header X-Content-Type-Options \"nosniff\" always;
    add_header X-XSS-Protection \"1; mode=block\" always;
}
EOF"
   ```

5. Enable the site:
   ```bash
   ssh mekaelturner "ln -sf /etc/nginx/sites-available/image-generator /etc/nginx/sites-enabled/"
   ssh mekaelturner "rm -f /etc/nginx/sites-enabled/default"
   ```

6. Test nginx configuration:
   ```bash
   ssh mekaelturner "nginx -t"
   ```

7. Reload nginx:
   ```bash
   ssh mekaelturner "systemctl reload nginx"
   ```

WHY: nginx is lightweight (~30MB RAM) and production-grade. Serves static files efficiently and will proxy API calls.
  </action>
  <verify>
- nginx installed on server (check with: ssh mekaelturner "nginx -v")
- /var/www/image-generator/ exists with uploaded files
- nginx config test passes
- Site is enabled
- nginx is running (ssh mekaelturner "systemctl status nginx")
  </verify>
  <done>
nginx installed and configured to serve static files at image-generator.mekaelturner.com
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure nginx API proxy to DashScope</name>
  <files>server: /etc/nginx/sites-available/image-generator</files>
  <action>
Configure nginx to proxy API calls to DashScope with authentication:

1. Add DashScope API key to environment (on server):
   ```bash
   ssh mekaelturner "echo 'export DASHSCOPE_API_KEY=\"sk-your-api-key-here\"' >> /etc/environment"
   ```

2. Update nginx configuration to add API proxy location:
   ```bash
   ssh mekaelturner "cat > /etc/nginx/sites-available/image-generator << 'EOF'
server {
    listen 80;
    server_name image-generator.mekaelturner.com;

    # Serve React static files
    root /var/www/image-generator;
    index index.html;

    # Handle React Router
    location / {
        try_files \$uri \$uri/ /index.html;
    }

    # Proxy DashScope API calls
    location /api/qwen/ {
        # Proxy to DashScope API
        proxy_pass https://dashscope.aliyuncs.com/api/v1/;

        # Add authentication header
        # Replace YOUR_API_KEY below with actual key
        proxy_set_header Authorization \"Bearer YOUR_DASHSCOPE_API_KEY\";
        proxy_set_header Host dashscope.aliyuncs.com;

        # CORS headers
        add_header Access-Control-Allow-Origin \"*\" always;
        add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\" always;
        add_header Access-Control-Allow-Headers \"Authorization, Content-Type\" always;

        # Handle OPTIONS preflight
        if (\$request_method = 'OPTIONS') {
            return 204;
        }

        # Proxy headers
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Cache static assets
    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control \"public, immutable\";
    }

    # Security headers
    add_header X-Frame-Options \"SAMEORIGIN\" always;
    add_header X-Content-Type-Options \"nosniff\" always;
    add_header X-XSS-Protection \"1; mode=block\" always;
}
EOF"
   ```

3. IMPORTANT: Replace YOUR_DASHSCOPE_API_KEY with actual key:
   ```bash
   ssh mekaelturner "nano /etc/nginx/sites-available/image-generator"
   # Edit the proxy_set_header Authorization line
   # Or use sed to replace:
   ssh mekaelturner "sed -i 's/YOUR_DASHSCOPE_API_KEY/sk-actual-key-here/g' /etc/nginx/sites-available/image-generator"
   ```

4. Test and reload nginx:
   ```bash
   ssh mekaelturner "nginx -t && systemctl reload nginx"
   ```

WHY: nginx can proxy API calls server-to-server (no CORS issues). The Authorization header is added dynamically to every proxied request.
  </action>
  <verify>
- nginx configuration includes /api/qwen/ location block
- Authorization header configured with actual API key
- CORS headers present
- nginx config test passes
- nginx reloaded successfully
  </verify>
  <done>
nginx configured to proxy /api/qwen/ calls to DashScope API with authentication
  </done>
</task>

<task type="auto">
  <name>Task 4: Configure DNS for custom domain</name>
  <files>DNS management console for mekaelturner.com</files>
  <action>
Configure DNS to point image-generator.mekaelturner.com to the server:

1. Get server IP address:
   ```bash
   ssh mekaelturner "curl -s ifconfig.me"
   ```
   Note the IP address (e.g., 137.184.143.235)

2. Add DNS record for mekaelturner.com:
   - Access DNS management for mekaelturner.com
   - Add A record or CNAME record:
     - Name/Host: image-generator
     - Type: A
     - Value/Target: [server IP address]
     - TTL: 3600 (or default)
   - Save DNS changes

3. Verify DNS propagation:
   ```bash
   dig image-generator.mekaelturner.com
   ```
   Should resolve to server IP address

4. Test HTTP access:
   ```bash
   curl -I http://image-generator.mekaelturner.com
   ```
   Should return 200 OK with nginx headers

WHY: DNS is required for the custom domain to resolve to your server. propagation takes 5-30 minutes.
  </action>
  <verify>
- DNS record added for image-generator subdomain
- dig shows correct IP resolution
- curl http://image-generator.mekaelturner.com returns 200
- nginx default page or app loads
  </verify>
  <done>
DNS configured, image-generator.mekaelturner.com points to server IP
  </done>
</task>

<task type="auto">
  <name>Task 5: Set up SSL certificate with Let's Encrypt</name>
  <files>server: /etc/letsencrypt/live/image-generator.mekaelturner.com/</files>
  <action>
Install SSL certificate using certbot for HTTPS:

1. Ensure DNS has propagated (from Task 4):
   ```bash
   dig image-generator.mekaelturner.com
   ```
   Should resolve to server IP

2. Obtain SSL certificate with certbot:
   ```bash
   ssh mekaelturner "certbot --nginx -d image-generator.mekaelturner.com --non-interactive --agree-tos --email your@email.com --redirect"
   ```
   - --nginx: Automatically configures nginx
   - --redirect: Force HTTPS redirect
   - --non-interactive: Runs without prompts
   - --agree-tos: Accept terms
   - --email: Your email for renewal notices

3. Verify certificate was installed:
   ```bash
   ssh mekaelturner "ls -la /etc/letsencrypt/live/image-generator.mekaelturner.com/"
   ```
   Should show: fullchain.pem, privkey.pem

4. Check nginx configuration (certbot auto-updates it):
   ```bash
   ssh mekaelturner "cat /etc/nginx/sites-available/image-generator"
   ```
   Should now have listen 443 ssl and cert paths

5. Test HTTPS access:
   ```bash
   curl -I https://image-generator.mekaelturner.com
   ```
   Should return 200 OK

WHY: Let's Encrypt provides free SSL certificates. certbot auto-configures nginx and sets up auto-renewal.
  </action>
  <verify>
- SSL certificate obtained successfully
- Certificate files exist in /etc/letsencrypt/live/
- nginx configured for HTTPS (listen 443 ssl)
- HTTPS works: curl https://image-generator.mekaelturner.com
- HTTP redirects to HTTPS
- certbot timer installed (check with: ssh mekaelturner "systemctl list-timers | grep certbot")
  </verify>
  <done>
SSL certificate installed, HTTPS enabled, HTTP redirects to HTTPS
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Deployed application at https://image-generator.mekaelturner.com with nginx serving static files and proxying API calls</what-built>
  <how-to-verify>
    1. Visit https://image-generator.mekaelturner.com
       - Confirm HTTPS works (no security warnings)
       - Confirm SSL certificate is valid
    2. Verify app loads without errors
       - Check browser console for errors
       - All assets load (CSS, JS, images)
    3. Test image generation:
       - Enter prompt: "a beautiful sunset over mountains"
       - Click "Generate Image"
       - Wait 1-2 minutes for image generation
       - Confirm image displays successfully
    4. Verify API calls work:
       - Check browser Network tab for /api/qwen/ requests
       - Verify requests return 200 OK
       - Verify Authorization header is present
       - No CORS errors in console
    5. Test all features:
       - Download button works
       - Start over button works
       - Responsive design on mobile (use DevTools)
    6. Test from different browsers:
       - Chrome/Firefox/Safari
       - Mobile browser if available

    Expected outcome:
    - App loads at https://image-generator.mekaelturner.com
    - HTTPS with valid SSL certificate
    - Image generation completes successfully
    - Generated image displays
    - No CORS or API errors
    - All features functional
    - Mobile layout works
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Production build created (dist/ directory)
- [ ] nginx installed on server
- [ ] Static files uploaded to /var/www/image-generator/
- [ ] nginx configured to serve files
- [ ] API proxy configured with DashScope authentication
- [ ] DNS configured for image-generator.mekaelturner.com
- [ ] SSL certificate obtained and installed
- [ ] HTTPS works at https://image-generator.mekaelturner.com
- [ ] Image generation works end-to-end
- [ ] No CORS errors
- [ ] All features functional
- [ ] Mobile responsive design intact
</verification>

<success_criteria>

- Production build successful
- nginx installed and configured on mekaelturner server
- Static files served correctly
- API proxy works with DashScope authentication
- DNS resolves custom domain to server
- SSL certificate active (HTTPS works)
- Image generation works in production
- All features functional (generate, download, start over)
- Mobile responsive design intact
- Server resources acceptable (< 100MB RAM usage)
  </success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Deployment Summary

**Application deployed to https://image-generator.mekaelturner.com using nginx**

## Accomplishments

- Built production bundle locally (dist/)
- Installed nginx on mekaelturner server
- Configured nginx to serve static React files
- Set up nginx reverse proxy for DashScope API calls
- Added DashScope API authentication to nginx config
- Configured DNS for image-generator.mekaelturner.com
- Obtained SSL certificate with Let's Encrypt/certbot
- Verified image generation works end-to-end
- Tested all features (generate, download, start over)
- Confirmed mobile responsive design

## Files Created/Modified

**Local machine:**
- `dist/` - Production build output (uploaded to server)

**Server (mekaelturner):**
- `/var/www/image-generator/` - Static files
- `/etc/nginx/sites-available/image-generator` - nginx configuration
- `/etc/letsencrypt/live/image-generator.mekaelturner.com/` - SSL certificates
- `/etc/environment` - DASHSCOPE_API_KEY (or in nginx config)

## Deployment URL

- **Production**: https://image-generator.mekaelturner.com
- **Server IP**: 137.184.143.235

## Server Configuration

- **OS**: Ubuntu 24.04 LTS
- **Web server**: nginx 1.24.0
- **SSL**: Let's Encrypt (auto-renewal via certbot)
- **RAM usage**: ~30-50MB (well within 961MB limit)
- **Static files**: Served from /var/www/image-generator
- **API proxy**: nginx proxies /api/qwen/ to DashScope API
- **Authentication**: Authorization header added by nginx

## DNS Configuration

- **Domain**: image-generator.mekaelturner.com
- **Type**: A record
- **Target**: 137.184.143.235
- **SSL**: Automatic (Let's Encrypt)

## Decisions Made

- **nginx-only deployment**: Chose nginx over Node.js backend due to limited RAM (961MB)
- **Build locally**: Build on Raspberry Pi, upload static files to server (simpler than building on server)
- **nginx API proxy**: nginx handles API proxying server-to-server (no CORS issues)
- **Let's Encrypt**: Free SSL certificates with auto-renewal
- **Authentication in nginx**: DashScope API key stored in nginx config (server is root-only)

## Issues Encountered

- API key storage in nginx config (less ideal than env var, but acceptable for single-user server)
- DNS propagation delay (5-30 minutes)
- Manual API key replacement required in nginx config

## Server Resources

- **RAM before**: ~300MB
- **RAM after**: ~30-50MB (nginx + static files)
- **Disk usage**: ~10MB for static files
- **CPU load**: Minimal (nginx is very efficient)

## Next Phase Readiness

Ready for Phase 7 Plan 3: China Access Verification
- App is deployed at custom domain
- Image generation works
- HTTPS enabled
- Need to verify access from China network
- Need to test performance from China
</output>
