---
phase: 07-deployment
plan: 01
type: execute
---

<objective>
Create GitHub Actions CI/CD workflow to automate testing, building, and deployment from local → GitHub → production (image-generator.mekaelturner.com).

Purpose: Streamline deployment workflow so pushing to GitHub automatically tests, builds, and deploys to production server.
Output: GitHub Actions workflow that runs tests on all branches, deploys to production on main branch pushes.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/07-deployment/07-02-PLAN.md
@.planning/phases/07-deployment/07-01-SUMMARY.md
@.planning/phases/02-qwen-integration/02-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@package.json
@.github/workflows/ (will be created)
@ssh mekaelturner (deployment target)

**Tech stack available:** React 19, Vite 6, TypeScript, Tailwind CSS v4, Vitest, Playwright
**Established patterns:**
- Production build: `npm run build` → `dist/` (from 07-01)
- Unit tests: `npm run test:run` (Vitest)
- E2E tests: `npm run test:e2e` (Playwright)
- GitHub repo: https://github.com/mekkamagnus/ai-image-generator
- Deployment server: mekaelturner (137.184.143.235, Ubuntu 24.04 LTS, 961MB RAM)

**Deployment Architecture (from 07-02 plan):**
- Build locally (Raspberry Pi): `npm run build` → `dist/`
- Upload to server: `rsync -avz --delete dist/ mekaelturner:/var/www/image-generator/`
- Serve with nginx (30-50MB RAM, reverse proxy for API calls)
- DashScope API key stored in nginx config
- Production URL: https://image-generator.mekaelturner.com

**CI/CD Requirements:**
- GitHub Actions for workflow automation
- SSH key for deployment to mekaelturner server
- Environment variables for secrets (DashScope API key)
- Automated testing on all branches
- Automated deployment on main branch

**Constraining decisions:**
- Phase 7-02: Manual deployment workflow (build locally, rsync to server, restart nginx)
- Phase 7-01: Production build configured
- GitHub repository already created (mekkamagnus/ai-image-generator)
- Server: nginx-only, no Node.js runtime (RAM constraint)
- Workflow: local dev → GitHub push → auto test → auto build → auto deploy (main only)

**Issues being addressed:**
- Manual deployment process is error-prone
- No automated testing before deployment
- No verification that tests pass before production deployment
- Deployment requires manual SSH into server
- No rollback mechanism if deployment breaks production

**From STATE.md:**
- Phase 7.1 inserted to automate: local → GitHub → production workflow
- GitHub Actions workflow, automated testing integration, environment variable management needed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow directory and base configuration</name>
  <files>.github/workflows/ci.yml, .github/workflows/deploy.yml</files>
  <action>
Create GitHub Actions workflow files:

1. Create `.github/workflows/` directory:
   ```bash
   mkdir -p .github/workflows
   ```

2. Create CI workflow `.github/workflows/ci.yml`:
   - Triggers: push to all branches, pull requests
   - Runs on: ubuntu-latest
   - Steps:
     a. Checkout code
     b. Setup Node.js (version from package.json.engines or 20.x)
     c. Install dependencies: `npm ci`
     d. Run linter: `npm run lint`
     e. Run unit tests: `npm run test:run`
     f. Upload test results as artifacts

3. Create deployment workflow `.github/workflows/deploy.yml`:
   - Triggers: push to main branch only
   - Runs on: ubuntu-latest
   - Steps:
     a. Checkout code
     b. Setup Node.js
     c. Install dependencies
     c. Run all tests (unit + E2E)
     d. Build production bundle: `npm run build`
     e. Deploy to mekaelturner server via SSH/rsync
     f. Verify deployment (health check)

4. Add workflows to git:
   ```bash
   git add .github/workflows/
   ```

WHY: GitHub Actions provides free CI/CD for public repositories. Separate workflows for CI (all branches) and deployment (main only) follows best practices.
  </action>
  <verify>
- .github/workflows/ directory exists
- ci.yml file exists with test steps
- deploy.yml file exists with build and deploy steps
- Workflows use correct Node version
- Deployment only triggers on main branch
  </verify>
  <done>
GitHub Actions workflows created with CI (test on all branches) and deployment (build + deploy on main)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure deployment SSH key and secrets</name>
  <files>.github/workflows/deploy.yml, server: ~/.ssh/authorized_keys</files>
  <action>
Set up SSH authentication for GitHub Actions to deploy to mekaelturner:

1. Generate SSH key pair for GitHub Actions:
   ```bash
   ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions_deploy
   ```

2. Add public key to mekaelturner server:
   ```bash
   cat ~/.ssh/github_actions_deploy.pub | ssh mekaelturner 'cat >> ~/.ssh/authorized_keys'
   ```

3. Configure deploy.yml to use SSH key:
   - Add secret setup step
   - Configure SSH key from secrets
   - Use ssh-agent for authentication
   - Disable host key checking (or add to known_hosts)

4. Add required GitHub secrets (document in .github/workflows/deploy.yml comments):
   - SSH_PRIVATE_KEY: Private key content
   - SSH_HOST: mekaelturner (137.184.143.235)
   - SSH_USER: root
   - DASHSCOPE_API_KEY: DashScope API key for nginx config

5. Update deploy.yml to use secrets:
   ```yaml
   - name: Deploy to server
     env:
       SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
       SSH_HOST: ${{ secrets.SSH_HOST }}
     run: |
       # Setup SSH
       mkdir -p ~/.ssh
       echo "$SSH_KEY" > ~/.ssh/deploy_key
       chmod 600 ~/.ssh/deploy_key

       # Deploy
       rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
         dist/ root@${SSH_HOST}:/var/www/image-generator/
   ```

WHY: GitHub Actions needs SSH access to deployment server. Using deploy key with restricted access follows security best practices.
  </action>
  <verify>
- SSH key pair generated (~/.ssh/github_actions_deploy)
- Public key added to mekaelturner authorized_keys
- deploy.yml configured to use SSH_PRIVATE_KEY secret
- All required secrets documented in workflow comments
- Host key checking configured
  </verify>
  <done>
SSH deployment key configured for GitHub Actions with secrets documented in workflow
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement automated deployment in GitHub Actions</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Complete the deployment workflow:

1. Add build step to deploy.yml:
   ```yaml
   - name: Build production bundle
     run: npm run build
   ```

2. Add deployment step (rsync dist/ to server):
   ```yaml
   - name: Deploy to production
     run: |
       # Setup SSH key
       mkdir -p ~/.ssh
       echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
       chmod 600 ~/.ssh/deploy_key
       ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

       # Deploy static files
       rsync -avz --delete \
         -e "ssh -i ~/.ssh/deploy_key" \
         dist/ \
         root@${{ secrets.SSH_HOST }}:/var/www/image-generator/

       # Verify deployment
       ssh -i ~/.ssh/deploy_key root@${{ secrets.SSH_HOST }} \
         "nginx -t && systemctl reload nginx"
   ```

3. Add DashScope API key injection (for nginx config update):
   ```yaml
   - name: Configure API key
     run: |
       ssh -i ~/.ssh/deploy_key root@${{ secrets.SSH_HOST }} \
         "sed -i 's/YOUR_DASHSCOPE_API_KEY/${{ secrets.DASHSCOPE_API_KEY }}/g' \
          /etc/nginx/sites-available/image-generator && \
          nginx -t && systemctl reload nginx"
   ```

4. Add deployment status check:
   ```yaml
   - name: Verify deployment
     run: |
       sleep 5  # Wait for nginx to reload
       curl -f https://image-generator.mekaelturner.com || exit 1
   ```

5. Add rollback on failure:
   ```yaml
   - name: Rollback on failure
     if: failure()
     run: |
       git checkout HEAD~1  # Revert to previous commit locally
       # Note: This won't rollback server, just marks workflow as failed
   ```

WHY: Automated deployment reduces human error. Health checks catch issues immediately. Rollback capability provides safety net.
  </action>
  <verify>
- deploy.yml builds dist/ before deployment
- rsync uploads to /var/www/image-generator/
- DashScope API key injected into nginx config
- nginx reloads after deployment
- HTTPS health check verifies deployment
- Rollback step configured for failure scenarios
  </verify>
  <done>
Automated deployment workflow builds, uploads, configures, and verifies production deployment
  </done>
</task>

<task type="auto">
  <name>Task 4: Add E2E testing to CI pipeline</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Extend CI workflow to include E2E tests:

1. Install Playwright browsers:
   ```yaml
   - name: Install Playwright browsers
     run: npx playwright install --with-deps
   ```

2. Add E2E test step (after unit tests):
   ```yaml
   - name: Run E2E tests
     run: npm run test:e2e
   ```

3. Configure Playwright for CI environment:
   - Set HEADLESS=true environment variable
   - Use xvfb if needed for Linux GUI tests
   - Upload test report as artifact

4. Add test result artifacts:
   ```yaml
   - name: Upload test results
     if: always()
     uses: actions/upload-artifact@v4
     with:
       name: test-results
       path: |
         test-results/
         playwright-report/
   ```

5. Update deploy.yml to require E2E tests:
   - Add E2E test step before deployment
   - Only deploy if all tests pass

WHY: E2E tests catch integration issues unit tests miss. Running in CI catches regressions before deployment.
  </action>
  <verify>
- Playwright browsers install in CI workflow
- E2E tests run after unit tests
- Test results uploaded as artifacts
- deploy.yml requires E2E tests to pass before deployment
- HEADLESS mode configured for CI environment
  </verify>
  <done>
E2E testing integrated into CI pipeline with artifact uploads and deployment gate
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete GitHub Actions CI/CD workflow with automated testing, building, and deployment to image-generator.mekaelturner.com</what-built>
  <how-to-verify>
    1. Review GitHub Actions workflows:
       - Check .github/workflows/ci.yml (test workflow)
       - Check .github/workflows/deploy.yml (deployment workflow)
       - Verify all required secrets are documented

    2. Verify SSH key setup:
       - Check key exists: ls -la ~/.ssh/github_actions_deploy
       - Check public key on server: ssh mekaelturner "grep github_actions ~/.ssh/authorized_keys"

    3. Create GitHub secrets (in GitHub UI):
       - Go to: https://github.com/mekkamagnus/ai-image-generator/settings/secrets/actions
       - Add secrets:
         * SSH_PRIVATE_KEY: (copy from: cat ~/.ssh/github_actions_deploy)
         * SSH_HOST: 137.184.143.235
         * SSH_USER: root
         * DASHSCOPE_API_KEY: (your actual DashScope API key)

    4. Test CI workflow:
       - Create a new branch: git checkout -b test-ci
       - Make a trivial change (e.g., update README)
       - Push to GitHub: git push origin test-ci
       - Check Actions tab: https://github.com/mekkamagnus/ai-image-generator/actions
       - Verify workflow runs and tests pass

    5. Test deployment workflow (ONLY after Phase 7-02 completes):
       - Merge test branch to main
       - Observe deployment workflow
       - Verify https://image-generator.mekaelturner.com updates

    Expected outcome:
    - Workflows created and committed to git
    - SSH key configured for deployment
    - CI runs on all branches
    - Deployment runs on main branch only
    - All tests must pass before deployment
  </how-to-verify>
  <resume-signal>Type "approved" to commit workflows and create SUMMARY, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .github/workflows/ directory created
- [ ] ci.yml workflow created with test steps
- [ ] deploy.yml workflow created with build and deploy steps
- [ ] SSH key generated for GitHub Actions
- [ ] Public key added to mekaelturner authorized_keys
- [ ] Workflows document all required secrets
- [ ] E2E tests integrated into CI pipeline
- [ ] Deployment only triggers on main branch
- [ ] Health checks verify deployment
- [ ] Rollback capability configured
</verification>

<success_criteria>

- GitHub Actions workflows created and committed
- SSH deployment key configured
- CI pipeline runs tests on all branches
- CD pipeline deploys to production on main branch
- E2E tests integrated before deployment
- Secrets documented and ready to configure
- Automated deployment workflow complete
  </success_criteria>

<output>
After completion, create `.planning/phases/7.1-add-ci-cd-integration-for-automated-deployment/7.1-01-SUMMARY.md`:

# Phase 7.1 Plan 1: CI/CD Integration Summary

**GitHub Actions CI/CD workflow implemented with automated testing, building, and deployment to production**

## Accomplishments

- Created GitHub Actions CI workflow (ci.yml)
- Created GitHub Actions deployment workflow (deploy.yml)
- Generated SSH key pair for GitHub Actions deployment
- Added public key to mekaelturner authorized_keys
- Documented all required GitHub secrets
- Integrated E2E testing into CI pipeline
- Configured deployment only on main branch
- Added health checks and rollback capability
- Automated workflow: local → GitHub → auto test → auto build → auto deploy

## Files Created/Modified

**Created:**
- `.github/workflows/ci.yml` - CI workflow (tests on all branches)
- `.github/workflows/deploy.yml` - CD workflow (build + deploy on main)
- `~/.ssh/github_actions_deploy` - Private SSH key for GitHub Actions
- `~/.ssh/github_actions_deploy.pub` - Public key (added to server)

**Modified (server):**
- `~/.ssh/authorized_keys` on mekaelturner (added public key)

## CI/CD Workflow

**On push to any branch:**
1. Checkout code
2. Setup Node.js (20.x)
3. Install dependencies (npm ci)
4. Run linter (npm run lint)
5. Run unit tests (npm run test:run)
6. Upload test results

**On push to main branch:**
1. Run all tests (unit + E2E)
2. Build production bundle (npm run build)
3. Deploy to mekaelturner server (rsync dist/)
4. Configure DashScope API key in nginx
5. Reload nginx
6. Verify deployment (HTTPS health check)
7. Rollback on failure

## GitHub Secrets Required

Configure at: https://github.com/mekkamagnus/ai-image-generator/settings/secrets/actions

- `SSH_PRIVATE_KEY` - Private SSH key for deployment
  - Get from: `cat ~/.ssh/github_actions_deploy`
- `SSH_HOST` - `137.184.143.235`
- `SSH_USER` - `root`
- `DASHSCOPE_API_KEY` - DashScope API key for nginx config

## Deployment Architecture

```
Local (Raspberry Pi)          GitHub (CI/CD)              Production
                          ├─ CI: Tests           mekaelturner Server
git push ───┼───> ──────────┤                          (nginx + static files)
                          └─ CD: Build + Deploy
```

**Workflow:**
1. Developer pushes to GitHub
2. GitHub Actions runs CI (tests)
3. On main branch: Builds dist/, uploads to server, reloads nginx
4. Production updates automatically at https://image-generator.mekaelturner.com

## Decisions Made

- **Separate CI/CD workflows** - CI on all branches, deployment on main only (prevents accidental deployments)
- **SSH deploy key** - Dedicated key for GitHub Actions (not personal SSH key, better security)
- **Test before deploy** - All tests (unit + E2E) must pass before deployment
- **Health check** - Verify HTTPS endpoint after deployment
- **Rollback on failure** - Mark workflow as failed if deployment breaks

## Next Steps

**After Phase 7-02 completes (manual deployment):**
1. Create GitHub secrets in repository settings
2. Test CI workflow by pushing to feature branch
3. Test deployment workflow by merging to main
4. Verify automated deployment to production
5. Monitor GitHub Actions logs for issues

## Integration Points

- **Phase 7-02**: Must complete manual deployment first (nginx setup, SSL, DNS)
- **Phase 7-03**: China access verification will test automated deployment
- **Future**: All deployments go through CI/CD, manual deployment only for emergencies

---
*Phase: 07-deployment (Plan 7.1)*
*Completed: [date]*
