---
phase: 07-deployment
type: execute
---

<objective>
Deploy the application to a hosting platform with proper environment variable configuration and CORS/API proxy handling.

Purpose: Make the application publicly accessible with working API calls through serverless functions or backend proxy.
Output: Deployed application accessible via URL with image generation working end-to-end.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/07-deployment/07-01-SUMMARY.md
@.planning/phases/02-qwen-integration/02-01-SUMMARY.md
@.planning/phases/05-error-handling/05-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@vite.config.ts
@src/lib/qwen-api.ts
@.env.example

**Tech stack available:** React 19, Vite 6, TypeScript, Tailwind CSS v4
**Established patterns:**
- Production build configured (from 07-01)
- .env.example documents DASHSCOPE_API_KEY
- CORS limitation acknowledged (needs proxy)

**Constraining decisions:**
- Phase 2: DashScope API integration (synchronous mode)
- Phase 2: Beijing region API endpoint
- Phase 7-01: Production build configured, .gitignore created

**Issues being addressed:**
- CORS blocks browser-to-API calls in production
- Need serverless function or backend proxy
- Environment variables must be configured on hosting platform
- Deployment must be accessible from China (Phase 7-03 will verify)

**From STATE.md:**
- Ready for deployment
- E2E tests passing (19/19)
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Select deployment platform</decision>
  <context>
The app needs deployment with API proxy capabilities. Three options with different tradeoffs for China access and ease of use:
  </context>
  <options>
    <option id="vercel">
      <name>Vercel</name>
      <pros>Zero-config deployment, built-in serverless functions (API routes), generous free tier, excellent DX, global CDN (including Hong Kong edge), automatic HTTPS, custom domains supported</pros>
      <cons>Mainland China access can be slow (CDN PoPs in HK, Singapore, Tokyo), may need Vercel's enterprise plan for optimal China performance</cons>
    </option>
    <option id="netlify">
      <name>Netlify</name>
      <pros>Zero-config deployment, serverless functions, free tier, good DX, edge functions available, automatic HTTPS, form handling built-in</pros>
      <cons>Similar China access limitations as Vercel, CDN coverage in China via Hong Kong/Singapore</cons>
    </option>
    <option id="cloudflare-pages">
      <name>Cloudflare Pages</name>
      <pros>Free unlimited bandwidth, global CDN including mainland China (rare!), Workers for API proxy, excellent performance, DDoS protection</pros>
      <cons>Newer platform (less mature), DX not as polished as Vercel, Workers have CPU time limits</cons>
    </option>
  </options>
  <resume-signal>Select: vercel, netlify, or cloudflare-pages</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Deploy to selected platform</name>
  <files>vercel.json OR netlify.toml OR wrangler.toml, api/api-qwen.ts (serverless function)</files>
  <action>
Deploy application to the selected platform with API proxy:

**If Vercel selected:**
1. Install Vercel CLI: npm install -g vercel
2. Create vercel.json configuration:
   - Build command: npm run build
   - Output directory: dist
   - Install command: npm install
3. Create serverless function at api/api-qwen.ts:
   - Proxy POST /api/qwen to https://dashscope.aliyuncs.com
   - Add DASHSCOPE_API_KEY from environment
   - Handle CORS headers
   - Return response with proper headers
4. Deploy: vercel --yes
5. Add environment variable: vercel env add DASHSCOPE_API_KEY
6. Redeploy: vercel --yes --prod

**If Netlify selected:**
1. Install Netlify CLI: npm install -g netlify-cli
2. Create netlify.toml configuration:
   - Build command: npm run build
   - Publish directory: dist
   - Functions directory: netlify/functions
3. Create serverless function at netlify/functions/api-qwen.ts:
   - Proxy POST requests to DashScope API
   - Add API key from environment
   - Handle CORS
4. Deploy: netlify deploy --prod
5. Add environment variable in Netlify dashboard
6. Redeploy to apply env vars

**If Cloudflare Pages selected:**
1. Install Wrangler CLI: npm install -g wrangler
2. Create wrangler.toml configuration
3. Create Workers function for API proxy:
   - Proxy requests to DashScope API
   - Add API key from environment
   - Handle CORS
4. Deploy with wrangler pages publish dist
5. Add environment variable via wrangler secret put
6. Test deployment

COMMON STEPS (all platforms):
- Update src/lib/qwen-api.ts to call /api/qwen (relative path)
- Remove production-specific direct API calls (use proxy instead)
- Test deployment URL works end-to-end
- Verify image generation succeeds

WHY: Browser cannot call DashScope API directly due to CORS. Serverless function proxies request server-to-server (no CORS).
  </action>
  <verify>
- Deployment command completes successfully
- Deployment URL is returned (e.g., https://myapp.vercel.app)
- Visit deployment URL: app loads without errors
- Enter prompt and generate: image generation succeeds
- No CORS errors in browser console
- API proxy logs show successful requests
  </verify>
  <done>
Application deployed successfully, image generation works end-to-end, API proxy handles CORS correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure production environment variables</name>
  <files>.env.production (local only), platform dashboard env vars</files>
  <action>
Set up environment variables for production:

1. Add DASHSCOPE_API_KEY to hosting platform:
   - Vercel: vercel env add DASHSCOPE_API_KEY production
   - Netlify: netlify env:set DASHSCOPE_API_KEY
   - Cloudflare: wrangler secret put DASHSCOPE_API_KEY

2. Verify environment variable is set:
   - Vercel: vercel env ls
   - Netlify: netlify env:list
   - Cloudflare: wrangler secret list

3. Test production build locally with env var:
   - Create .env.production (DO NOT commit)
   - Add: DASHSCOPE_API_KEY=your_actual_key
   - Run: npm run build
   - Run: npm run preview
   - Test image generation works

4. Verify deployment has access to env var:
   - Check serverless function logs
   - Confirm API key is loaded correctly
   - No "undefined" or "missing API key" errors

WHY: API calls fail without the key. Environment variables must be configured on the hosting platform, not committed to git.
  </action>
  <verify>
- Environment variable set in platform dashboard
- Platform CLI confirms env var exists
- Local production build works with .env.production
- Deployment logs show API key loaded successfully
- Image generation works on deployed app
  </verify>
  <done>
Production environment variables configured, API calls work in deployed app
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Deployed application with working API proxy and environment variables</what-built>
  <how-to-verify>
    1. Visit deployment URL (e.g., https://myapp.vercel.app)
    2. Verify app loads without errors (check browser console for errors)
    3. Test image generation:
       - Enter prompt: "a beautiful sunset over mountains"
       - Click "Generate Image"
       - Wait 1-2 minutes for image generation
       - Confirm image displays successfully
    4. Verify no CORS errors in browser console
    5. Verify no "missing API key" errors in server logs
    6. Test download button works
    7. Test start over button works
    8. Test mobile responsive (use DevTools device emulation if on desktop)

    Expected outcome:
    - App loads at deployment URL
    - Image generation completes successfully
    - Generated image displays
    - No CORS or API key errors
    - All buttons work
    - Mobile layout looks good
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Application deployed to hosting platform
- [ ] Deployment URL is accessible
- [ ] Serverless function proxies API requests
- [ ] Environment variables configured on platform
- [ ] Image generation works end-to-end
- [ ] No CORS errors
- [ ] No API key errors
- [ ] Mobile layout works
</verification>

<success_criteria>

- Application successfully deployed to chosen platform
- API proxy handles CORS correctly
- Environment variables configured securely
- Image generation works in production
- All features functional (generate, download, start over)
- Mobile responsive design intact
  </success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Deployment Summary

**Application deployed to [Platform] with working API proxy and environment variables**

## Accomplishments

- Deployed application to [Vercel/Netlify/Cloudflare Pages]
- Created serverless function for API proxy (solves CORS)
- Configured production environment variables (DASHSCOPE_API_KEY)
- Verified image generation works end-to-end
- Tested all features (generate, download, start over)
- Confirmed mobile responsive design

## Files Created/Modified

- `vercel.json` OR `netlify.toml` OR `wrangler.toml` - Platform configuration
- `api/api-qwen.ts` OR `netlify/functions/api-qwen.ts` - Serverless API proxy
- `src/lib/qwen-api.ts` - Updated to use API proxy
- `.env.production` - Local production testing (not committed)

## Deployment URL

- **Production**: https://your-app-url.vercel.app (or equivalent)
- **Git integration**: Connected to GitHub repo (if applicable)

## Decisions Made

- **Platform choice**: [Vercel/Netlify/Cloudflare Pages] with rationale
- **Serverless API proxy**: Required to solve CORS limitation
- **Environment variables**: Configured in platform dashboard (not in code)
- **GitHub auto-deploy**: Enabled/Disabled (if applicable)

## Issues Encountered

- CORS issue solved with serverless function
- Environment variable configuration required for API access
- [Any other issues and resolutions]

## Next Phase Readiness

Ready for Phase 7 Plan 3: China Access Verification
- App is deployed and publicly accessible
- Image generation works
- Need to verify access from China network
- Need to test performance from China
</output>
