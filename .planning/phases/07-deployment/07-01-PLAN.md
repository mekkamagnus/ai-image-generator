---
phase: 07-deployment
type: execute
---

<objective>
Configure production build with proper environment variable handling, security, and deployment readiness.

Purpose: Prepare the application for production deployment by fixing build configuration, securing sensitive data, and ensuring the app works without the dev server proxy.
Output: Production-ready build configuration with .env.example, .gitignore, and CORS/API handling for production.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/06-polish/06-01-SUMMARY.md
@.planning/phases/05-error-handling/05-01-SUMMARY.md
@.planning/phases/02-qwen-integration/02-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@package.json
@vite.config.ts
@src/lib/qwen-api.ts
@.env

**Tech stack available:** React 19, Vite 6, TypeScript, Tailwind CSS v4
**Established patterns:**
- Vite dev server proxy for API calls (dev only)
- DASHSCOPE_API_KEY in .env file
- Direct API calls to DashScope using fetch
- CORS handled by Vite proxy in development

**Constraining decisions:**
- Phase 2: DashScope API integration with synchronous mode
- Phase 2: Beijing region API (https://dashscope.aliyuncs.com)
- Phase 5: Error handling with retry logic
- Phase 6: All E2E tests passing (19/19)

**Issues being addressed:**
- Dev server proxy won't work in production (needs serverless function or direct API calls)
- No .gitignore (.env could be committed)
- No .env.example (documentation missing)
- Build may have TypeScript errors (pre-existing issues in test files)

**From STATE.md:**
- Ready for Phase 7: Deployment
- Production build configuration needed
- E2E tests cover happy path, errors, responsive design
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .gitignore and secure sensitive files</name>
  <files>.gitignore, .env.example</files>
  <action>
Create .gitignore to prevent committing sensitive files:

1. Create .gitignore with standard Node/Vite ignores:
   - Dependencies: node_modules/
   - Build outputs: dist/, build/
   - Environment files: .env, .env.local, .env.*.local
   - IDE files: .vscode/, .idea/, *.swp, *.swo
   - Test outputs: coverage/, test-results/, playwright-report/, playwright/.cache/
   - OS files: .DS_Store, Thumbs.db
   - Logs: *.log, npm-debug.log*, yarn-debug.log*, yarn-error.log*
   - Temporary files: *.tmp, .temp, .cache/
   - PocketBase: pocketbase/ (binary, should be in PATH)

2. Copy .env to .env.example
   - Replace actual API key with placeholder: DASHSCOPE_API_KEY=your_api_key_here
   - Add comment explaining how to get API key from DashScope console
   - Document all environment variables with descriptions

3. Verify .env is NOT tracked:
   - Run: git status
   - Confirm .env not in list
   - If .env was previously committed, remove from git history: git rm --cached .env

WHY: Security. API keys in version control are a major vulnerability. .env files should NEVER be committed.
  </action>
  <verify>
- .gitignore exists and contains .env, node_modules/, dist/
- .env.example exists with placeholder values
- git status does NOT show .env
- git check-ignore .env returns .env (confirms it's ignored)
  </verify>
  <done>
.gitignore created with comprehensive ignores, .env.example with documentation, .env not tracked by git
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix production build configuration</name>
  <files>vite.config.ts, tsconfig.json</files>
  <action>
Configure Vite for production build with proper base path and CORS handling:

1. Update vite.config.ts:
   - Add `base: '/'` for production (default, but explicit is better)
   - Ensure build.outDir is 'dist' (default)
   - Add build.rollupOptions.output.manualChunks for better caching
   - Ensure preview server is configured for testing production builds

2. Fix TypeScript build errors (if any):
   - Check if tests have unused imports causing build failures
   - Add "exclude": ["**/*.test.ts", "**/*.test.tsx", "**/*.spec.ts"] to tsconfig.json if tests are blocking build
   - OR fix the unused imports in test files (preferred)

3. Verify build command works:
   - Run: npm run build
   - Should generate dist/ directory with index.html and assets
   - No TypeScript errors should remain

4. Test preview server:
   - Run: npm run preview
   - Visit: http://localhost:4173
   - Confirm app loads (API calls will fail without CORS, that's addressed in Task 3)

WHY: Production builds must be clean. TypeScript errors or misconfiguration will cause deployment failures.
  </action>
  <verify>
- npm run build completes without errors
- dist/ directory exists with index.html
- npm run preview serves the production build
- app loads in browser (API calls handled in next task)
  </verify>
  <done>
Production build configured, TypeScript errors resolved, dist/ generated successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle API calls in production (CORS workaround)</name>
  <files>src/lib/qwen-api.ts, vite.config.ts</files>
  <action>
The Vite dev server proxy only works in development. Production deployments need a different approach. Implement one of these solutions:

**Option A: Direct API calls with CORS proxy (RECOMMENDED for Vercel/Netlify)**

1. Update src/lib/qwen-api.ts to call DashScope API directly:
   - In production, use `https://dashscope.aliyuncs.com` directly
   - Bypass Vite proxy when NODE_ENV === 'production'
   - Set mode: 'cors' in fetch requests
   - Include Authorization header with API key

2. Note: This will fail in browser due to CORS. For actual production, you need:
   - Vercel/Netlify serverless function (see Phase 7-02)
   - OR CORS proxy service (temporary workaround)
   - OR backend API (your existing PocketBase could proxy)

**Option B: Use PocketBase as proxy (if already running)**

1. Add proxy endpoint to PocketBase hooks (pb_data/hooks/extend.go)
2. Update frontend to call PocketBase instead of DashScope directly
3. PocketBase handles server-to-server communication (no CORS)

For THIS task (build config), implement Option A with a TODO comment indicating CORS handling is needed in deployment phase:

```typescript
// In production, API calls need server-side proxy to avoid CORS
// This will be addressed in deployment phase (serverless function or backend)
if (import.meta.env.PROD) {
  // Direct call (will fail without CORS proxy - deployment will add proxy)
  apiUrl = 'https://dashscope.aliyuncs.com/...'
}
```

WHY: Dev proxy doesn't work in production. Need to acknowledge this limitation and plan for serverless/backend proxy in actual deployment.
  </action>
  <verify>
- src/lib/qwen-api.ts has production API call logic
- Code comments explain CORS limitation
- TODO indicates deployment phase will add proxy
- Build still succeeds (no new errors)
  </verify>
  <done>
API calls configured for production with documented CORS workaround, ready for deployment proxy
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production build configuration with .gitignore, .env.example, fixed TypeScript errors, and production API call handling</what-built>
  <how-to-verify>
    1. Verify .gitignore: cat .gitignore shows .env, node_modules/, dist/ are ignored
    2. Verify .env.example: cat .env.example shows placeholder API key with documentation
    3. Verify .env not tracked: git status does NOT show .env
    4. Test build: npm run build completes successfully
    5. Test preview: npm run preview and visit http://localhost:4173
    6. Verify API code: src/lib/qwen-api.ts has production logic with CORS comments

    Expected outcome:
    - .gitignore exists and is comprehensive
    - .env.example documents all required environment variables
    - .env is NOT in git status
    - Build completes without errors
    - Preview server serves the app
    - Code acknowledges CORS limitation with TODO for deployment proxy
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .gitignore exists and contains .env, node_modules/, dist/
- [ ] .env.example exists with documentation
- [ ] npm run build succeeds without errors
- [ ] npm run preview serves the app
- [ ] src/lib/qwen-api.ts handles production API calls
- [ ] Code comments explain CORS limitation
- [ ] No TypeScript errors in build
</verification>

<success_criteria>

- Production build configuration complete
- .gitignore securing sensitive files
- .env.example documenting environment variables
- Build succeeds without errors
- Preview server works
- API calls configured for production with documented CORS workaround
  </success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Production Build Configuration Summary

**Production build configured with security, environment variables, and API call handling**

## Accomplishments

- Created .gitignore to secure sensitive files (.env, node_modules/, dist/)
- Created .env.example with documented environment variables
- Fixed TypeScript build errors
- Configured Vite for production builds
- Implemented production API call logic with CORS workaround documented
- Verified build and preview server work

## Files Created/Modified

- `.gitignore` - Secures sensitive files from version control
- `.env.example` - Documents required environment variables
- `vite.config.ts` - Production build configuration
- `src/lib/qwen-api.ts` - Production API call handling
- `tsconfig.json` - Excluded test files if needed

## Decisions Made

- **Direct API calls in production**: Will need CORS proxy (serverless function or backend) in deployment phase
- **.gitignore over .env.gcp**: Standard .gitignore pattern is more universally understood
- **Exclude test files from build**: Pre-existing unused imports in test files don't block production builds

## Issues Encountered

- Pre-existing TypeScript errors in test files (unresolved - excluded from build)
- CORS limitation acknowledged (will be solved in 07-02 with serverless function or backend proxy)

## Next Phase Readiness

Ready for Phase 7 Plan 2: Deployment to hosting platform
- Production build works
- Environment variables documented
- Security (.gitignore) in place
- CORS workaround documented, ready for serverless/backend proxy implementation
</output>
